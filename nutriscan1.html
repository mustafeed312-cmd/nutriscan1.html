<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriSense AI: Web Nutrition Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        /* Custom styles for the chart container to manage size and prevent overflow */
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 400px; 
            margin-left: auto; 
            margin-right: auto; 
            height: 250px; 
            max-height: 250px; 
            transition: all 0.3s ease; 
        }
        @media (min-width: 640px) {
            .chart-container { 
                height: 300px; 
                max-height: 300px; 
            }
        }
        .text-input-group {
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="min-h-screen antialiased flex flex-col items-center p-4 sm:p-8">

    <!-- Main Container -->
    <div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 sm:p-10 border border-slate-100">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-700 tracking-tight">NutriSense AI</h1>
            <p class="text-slate-500 mt-2 text-lg">Instant Nutrition Analysis via Camera</p>
        </header>

        <!-- Main Application Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- 1. Input Panel (Camera/Upload) -->
            <section class="lg:col-span-1 flex flex-col space-y-4">
                <h2 class="text-xl font-semibold text-slate-700 mb-2 border-b pb-2">1. Capture Your Meal</h2>
                
                <!-- Camera/Input Toggle -->
                <div class="flex space-x-2">
                    <button id="mode-camera" class="flex-1 px-4 py-2 text-sm font-medium rounded-xl bg-indigo-600 text-white shadow-md hover:bg-indigo-700 transition active:bg-indigo-800">
                        &#128247; Use Camera
                    </button>
                    <button id="mode-text" class="flex-1 px-4 py-2 text-sm font-medium rounded-xl bg-slate-200 text-slate-700 hover:bg-slate-300 transition active:bg-slate-400">
                        &#128221; Text Description
                    </button>
                </div>

                <!-- Live Camera Feed (Canvas) -->
                <div id="camera-group" class="bg-slate-100 rounded-xl overflow-hidden shadow-inner h-64 flex items-center justify-center border border-slate-300">
                    <video id="video-feed" class="w-full h-full object-cover hidden" autoplay></video>
                    <canvas id="camera-canvas" class="hidden"></canvas>
                    <div id="camera-placeholder" class="text-slate-400 text-center p-4">
                        Click 'Use Camera' to activate the feed.
                    </div>
                </div>

                <!-- Text Input Group (Hidden by default) -->
                <div id="text-input-group" class="text-input-group flex flex-col space-y-3">
                    <textarea id="text-prompt" rows="4" placeholder="e.g., A plate with grilled salmon (150g), steamed broccoli, and a scoop of brown rice." class="w-full p-3 border border-slate-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                </div>

                <!-- Action Buttons -->
                <button id="capture-button" class="w-full px-6 py-3 text-lg font-semibold rounded-2xl bg-indigo-600 text-white shadow-lg hover:bg-indigo-700 transition active:bg-indigo-800 focus:outline-none focus:ring-4 focus:ring-indigo-300 disabled:opacity-50" disabled>
                    Analyze Meal
                </button>
                <div id="loading-indicator" class="hidden text-center text-indigo-600 font-medium">
                    <div class="animate-spin inline-block w-5 h-5 border-2 border-current border-t-transparent rounded-full mr-2"></div>
                    Analyzing image. Please wait...
                </div>

                <!-- Error Message Box -->
                <div id="error-box" class="hidden p-3 bg-red-100 border border-red-300 text-red-700 rounded-xl text-sm"></div>
            </section>

            <!-- 2. Output Panel (Summary and Chart) -->
            <section class="lg:col-span-2 flex flex-col space-y-6">
                <h2 class="text-xl font-semibold text-slate-700 mb-2 border-b pb-2">2. Nutritional Breakdown</h2>
                
                <div id="analysis-results" class="space-y-6">
                    <!-- Placeholder Text -->
                    <div id="initial-placeholder" class="p-8 bg-slate-50 rounded-xl border border-slate-200 text-center text-slate-500 h-full flex flex-col justify-center items-center">
                        <span class="text-6xl mb-4">&#129385;</span>
                        <p class="text-lg font-medium">Capture a food image or describe your meal to begin analysis.</p>
                        <p class="text-sm mt-2">The AI will provide estimated calories, macros, and health benefits.</p>
                    </div>

                    <!-- Macro Chart & Key Stats -->
                    <div id="data-display" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-4 sm:p-6 rounded-xl shadow-md">
                        
                        <!-- Col 1: Chart -->
                        <div class="md:col-span-1 flex flex-col">
                            <h3 class="font-bold text-slate-700 mb-2">Macronutrient Distribution</h3>
                            <div class="chart-container">
                                <canvas id="macroChart"></canvas>
                            </div>
                        </div>

                        <!-- Col 2: Key Stats -->
                        <div class="md:col-span-1 space-y-3 pt-4">
                            <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">Key Metrics</h3>
                            <div id="cal-stat" class="flex justify-between items-center p-3 bg-indigo-50 rounded-lg">
                                <span class="font-semibold text-indigo-700">Total Estimated Calories</span>
                                <span class="font-extrabold text-xl text-indigo-800" data-key="calories">0 kcal</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="font-medium text-slate-600">Protein</span>
                                <span class="font-bold text-slate-800" data-key="protein">0 g</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="font-medium text-slate-600">Fats</span>
                                <span class="font-bold text-slate-800" data-key="fats">0 g</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="font-medium text-slate-600">Carbohydrates</span>
                                <span class="font-bold text-slate-800" data-key="carbs">0 g</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Qualitative Insight -->
                    <div id="qualitative-insight" class="hidden bg-white p-4 sm:p-6 rounded-xl shadow-md border border-slate-100">
                        <h3 class="font-bold text-slate-700 mb-2 flex items-center gap-2">&#128173; AI Summary & Benefits</h3>
                        <p id="analysis-text" class="text-slate-600 leading-relaxed"></p>
                        <p class="text-xs text-slate-400 mt-4 italic">Disclaimer: Nutritional estimates are for informational purposes only and may vary.</p>
                    </div>
                </div>

            </section>

        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const API_KEY = ""; // Canvas environment provides this if empty

        // UI Elements
        const videoFeed = document.getElementById('video-feed');
        const cameraCanvas = document.getElementById('camera-canvas');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const captureButton = document.getElementById('capture-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorBox = document.getElementById('error-box');
        const initialPlaceholder = document.getElementById('initial-placeholder');
        const dataDisplay = document.getElementById('data-display');
        const qualitativeInsight = document.getElementById('qualitative-insight');
        const textPromptInput = document.getElementById('text-prompt');
        const textInputGroup = document.getElementById('text-input-group');
        const cameraGroup = document.getElementById('camera-group');
        const modeCameraBtn = document.getElementById('mode-camera');
        const modeTextBtn = document.getElementById('mode-text');
        
        let currentMode = 'camera'; // State: 'camera' or 'text'
        let stream = null;
        let macroChartInstance = null;
        
        // --- DATA STRUCTURE FOR AI RESPONSE ---
        // We instruct the AI to return a specific JSON structure for reliable parsing.
        const JSON_SCHEMA = {
            type: "OBJECT",
            properties: {
                calories: { "type": "NUMBER", "description": "Total estimated energy content in kcal." },
                protein: { "type": "NUMBER", "description": "Estimated protein amount in grams." },
                fats: { "type": "NUMBER", "description": "Estimated total fat amount in grams." },
                carbs: { "type": "NUMBER", "description": "Estimated total carbohydrate amount in grams." },
                summary: { "type": "STRING", "description": "A short, engaging paragraph summarizing the analysis, benefits, or dietary context of the meal." }
            },
            required: ["calories", "protein", "fats", "carbs", "summary"]
        };

        // --- CHART UTILITIES ---
        function renderMacroChart(data) {
            const ctx = document.getElementById('macroChart').getContext('2d');
            const proteinPct = (data.protein / (data.protein + data.fats + data.carbs)) * 100 || 0;
            const fatsPct = (data.fats / (data.protein + data.fats + data.carbs)) * 100 || 0;
            const carbsPct = (data.carbs / (data.protein + data.fats + data.carbs)) * 100 || 0;

            const macroData = {
                labels: ['Protein', 'Fats', 'Carbs'],
                datasets: [{
                    data: [proteinPct, fatsPct, carbsPct],
                    backgroundColor: [
                        'rgba(79, 70, 229, 0.8)', // Indigo
                        'rgba(249, 115, 22, 0.8)', // Orange
                        'rgba(16, 185, 129, 0.8)'  // Emerald
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            };

            if (macroChartInstance) {
                macroChartInstance.data = macroData;
                macroChartInstance.update();
            } else {
                macroChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: macroData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 10,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed.toFixed(1) + '%';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateStat(key, value, unit) {
            const el = document.querySelector(`[data-key="${key}"]`);
            if (el) {
                el.textContent = `${value.toFixed(1)} ${unit}`;
            }
        }

        function updateUI(data, text) {
            // Update individual stats
            updateStat('calories', data.calories, 'kcal');
            updateStat('protein', data.protein, 'g');
            updateStat('fats', data.fats, 'g');
            updateStat('carbs', data.carbs, 'g');

            // Update qualitative text
            document.getElementById('analysis-text').textContent = text;
            
            // Render chart
            renderMacroChart(data);

            // Show results and hide placeholder
            initialPlaceholder.classList.add('hidden');
            dataDisplay.classList.remove('hidden');
            qualitativeInsight.classList.remove('hidden');
        }

        // --- CAMERA LOGIC ---

        function startCamera() {
            if (stream) return; // Camera already running

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(s => {
                    stream = s;
                    videoFeed.srcObject = stream;
                    videoFeed.classList.remove('hidden');
                    cameraPlaceholder.classList.add('hidden');
                    captureButton.disabled = false;
                    captureButton.textContent = "Capture & Analyze";
                })
                .catch(err => {
                    displayError('Camera access denied or failed: ' + err.name);
                    captureButton.disabled = true;
                });
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            videoFeed.classList.add('hidden');
            cameraPlaceholder.classList.remove('hidden');
            captureButton.disabled = true;
            captureButton.textContent = "Analyze Meal";
        }

        function setupCameraMode() {
            currentMode = 'camera';
            modeCameraBtn.classList.replace('bg-slate-200', 'bg-indigo-600');
            modeCameraBtn.classList.replace('text-slate-700', 'text-white');
            modeTextBtn.classList.replace('bg-indigo-600', 'bg-slate-200');
            modeTextBtn.classList.replace('text-white', 'text-slate-700');
            
            textInputGroup.style.display = 'none';
            cameraGroup.classList.remove('hidden');
            
            // Auto-start camera on mode selection
            startCamera();
        }

        function setupTextMode() {
            currentMode = 'text';
            modeTextBtn.classList.replace('bg-slate-200', 'bg-indigo-600');
            modeTextBtn.classList.replace('text-slate-700', 'text-white');
            modeCameraBtn.classList.replace('bg-indigo-600', 'bg-slate-200');
            modeCameraBtn.classList.replace('text-white', 'text-slate-700');

            // Stop camera if running
            stopCamera();
            
            textInputGroup.style.display = 'flex';
            cameraGroup.classList.add('hidden');
            
            // Enable button for text input
            captureButton.disabled = false;
            captureButton.textContent = "Analyze Text Description";
        }

        // --- GEMINI API COMMUNICATION ---
        
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function analyzeMeal(imageB64, promptText) {
            displayError('');
            loadingIndicator.classList.remove('hidden');
            captureButton.disabled = true;

            try {
                // Construct the full prompt for the model
                const modelPrompt = `Analyze the following meal. Provide a comprehensive nutritional breakdown (calories, protein, fats, carbs) and a summary of its health benefits or dietary context. Ensure the response adheres strictly to the provided JSON schema.`;
                
                const contents = [{
                    role: "user",
                    parts: [
                        { text: modelPrompt },
                        // Optional image data part
                        ...(imageB64 ? [{
                            inlineData: {
                                mimeType: "image/jpeg",
                                data: imageB64
                            }
                        }] : []),
                        // Optional text description part
                        ...(promptText ? [{ text: `The user describes the food as: "${promptText}"` }] : [])
                    ]
                }];

                const payload = {
                    contents: contents,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: JSON_SCHEMA,
                    },
                    tools: [{ "google_search": {} }] // Use search grounding for up-to-date nutrition info
                };

                const apiUrl = `${API_URL_BASE}?key=${API_KEY}`;
                
                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const candidate = result.candidates?.[0];
                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("AI response was empty or malformed.");
                }

                const jsonString = candidate.content.parts[0].text;
                const parsedData = JSON.parse(jsonString);

                // Update UI with structured data and summary text
                if (parsedData.calories && parsedData.summary) {
                    updateUI(parsedData, parsedData.summary);
                } else {
                    throw new Error("AI returned data in an unexpected format.");
                }

            } catch (error) {
                console.error("Analysis failed:", error);
                displayError("Analysis failed. Please try again or adjust your input. Details: " + error.message);
            } finally {
                loadingIndicator.classList.add('hidden');
                captureButton.disabled = false;
            }
        }

        // --- CAPTURE HANDLER ---
        captureButton.addEventListener('click', () => {
            if (currentMode === 'camera') {
                // 1. Capture image from video stream
                cameraCanvas.width = videoFeed.videoWidth;
                cameraCanvas.height = videoFeed.videoHeight;
                const context = cameraCanvas.getContext('2d');
                context.drawImage(videoFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
                
                // 2. Get base64 data
                const base64Image = cameraCanvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                
                // 3. Send to AI
                analyzeMeal(base64Image, null);

            } else if (currentMode === 'text') {
                const prompt = textPromptInput.value.trim();
                if (prompt.length < 10) {
                    displayError('Please enter a more detailed description of your meal.');
                    return;
                }
                // 3. Send to AI
                analyzeMeal(null, prompt);
            }
        });

        // --- MODE HANDLERS ---
        modeCameraBtn.addEventListener('click', setupCameraMode);
        modeTextBtn.addEventListener('click', setupTextMode);

        // --- UTILITIES ---
        function displayError(message) {
            if (message) {
                errorBox.textContent = 'Error: ' + message;
                errorBox.classList.remove('hidden');
            } else {
                errorBox.classList.add('hidden');
            }
        }

        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize in text mode by default, which is safer when run in an environment with strict camera permissions
            setupTextMode();
        });

    </script>
</body>
</html>